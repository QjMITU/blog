<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="the tianxia"><meta name="copyright" content="the tianxia"><meta name="generator" content="Hexo 5.4.0"><meta name="theme" content="hexo-theme-yun"><title>SpringBoot启动流程---SpringApplication类 | thetianxia-天下</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.25/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" href="/blog/favicon.ico"><link rel="mask-icon" href="/blog/favicon.ico" color="#0078E7"><link rel="alternate icon" href="/blog/yun.ico"><link rel="preload" href="/blog/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/blog/js/utils.js" as="script"><link rel="preload" href="/blog/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/blog/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"github.com","root":"/blog/","title":"天下的知识库","version":"1.6.2","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"../data/sentences.json"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><link rel="stylesheet" href="/blog/css/hexo-theme-yun.css"><script src="/blog/js/utils.js"></script><script src="/blog/js/hexo-theme-yun.js"></script><meta name="description" content="SpringBoot启动类 2.4.5123456@SpringBootApplicationpublic class Application &amp;#123;    public static void main(String[] args) &amp;#123;        SpringApplication.run(Application.class);    &amp;#125;&amp;#125;  启动类的代码">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringBoot启动流程---SpringApplication类">
<meta property="og:url" content="https://github.com/2023/06/29/SpringBoot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%202.4.5/index.html">
<meta property="og:site_name" content="thetianxia-天下">
<meta property="og:description" content="SpringBoot启动类 2.4.5123456@SpringBootApplicationpublic class Application &amp;#123;    public static void main(String[] args) &amp;#123;        SpringApplication.run(Application.class);    &amp;#125;&amp;#125;  启动类的代码">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262125014.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262132126.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262132235.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262132254.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262133370.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262133424.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262133278.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262133100.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262133633.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262133028.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262133895.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262134828.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262134978.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262134741.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262134720.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262135716.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262135059.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262135294.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262135618.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262135319.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262135227.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262135347.png">
<meta property="article:published_time" content="2023-06-29T10:51:34.381Z">
<meta property="article:modified_time" content="2023-12-04T12:14:24.234Z">
<meta property="article:author" content="the tianxia">
<meta property="article:tag" content="Spring Boot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262125014.png"><script src="/blog/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/blog/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/blog/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/blog/about/" title="the tianxia"><img width="96" loading="lazy" src="/blog/images/head_boji.jpg" alt="the tianxia"><span class="site-author-status" title="学习挣小钱钱">😤</span></a><div class="site-author-name"><a href="/blog/about/">the tianxia</a></div><span class="site-name">thetianxia-天下</span><sub class="site-subtitle">功不唐捐，玉汝于成</sub><div class="site-desciption">welcome to my blog,have a good time!</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/blog/" title="首页"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/blog/archives/" title="归档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">10</span></a></div><div class="site-state-item"><a href="/blog/categories/" title="分类"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">12</span></a></div><div class="site-state-item"><a href="/blog/tags/" title="标签"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">7</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://www.yuque.com/xiaocongbandoufu-suh9q" title="我的语雀"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-yuque"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="1874712420@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://wpa.qq.com/msgrd?v=3&amp;uin=1874712420&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com" title="GitHub" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/blog/albums/" title="我的相册" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-gallery-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringBoot%E5%90%AF%E5%8A%A8%E7%B1%BB-2-4-5"><span class="toc-number">1.</span> <span class="toc-text">SpringBoot启动类 2.4.5</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SpringApplication%E6%9E%84%E9%80%A0%E5%99%A8-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.1.</span> <span class="toc-text">SpringApplication构造器,初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%9A%E7%82%B91"><span class="toc-number">1.1.1.</span> <span class="toc-text">锚点1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%9A%E7%82%B92"><span class="toc-number">1.1.2.</span> <span class="toc-text">锚点2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Run%E5%85%B7%E4%BD%93%E5%90%AF%E5%8A%A8"><span class="toc-number">1.2.</span> <span class="toc-text">Run具体启动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%9A%E7%82%B93"><span class="toc-number">1.2.1.</span> <span class="toc-text">锚点3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%9A%E7%82%B94"><span class="toc-number">1.2.2.</span> <span class="toc-text">锚点4</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%9A%E7%82%B95"><span class="toc-number">1.2.3.</span> <span class="toc-text">锚点5</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%9A%E7%82%B96"><span class="toc-number">1.2.4.</span> <span class="toc-text">锚点6</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%9A%E7%82%B97"><span class="toc-number">1.2.5.</span> <span class="toc-text">锚点7</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%9A%E7%82%B98"><span class="toc-number">1.2.6.</span> <span class="toc-text">锚点8</span></a></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://github.com/blog/2023/06/29/SpringBoot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%202.4.5/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="the tianxia"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="thetianxia-天下"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">SpringBoot启动流程---SpringApplication类</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="创建时间：2023-06-29 18:51:34" itemprop="dateCreated datePublished" datetime="2023-06-29T18:51:34+08:00">2023-06-29</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="修改时间：2023-12-04 20:14:24" itemprop="dateModified" datetime="2023-12-04T20:14:24+08:00">2023-12-04</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/blog/categories/%E5%8D%9A%E5%AE%A2/" style="--text-color:dimgray" itemprop="url" rel="index"><span itemprop="text">博客</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/blog/categories/%E5%8D%9A%E5%AE%A2/Java/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Java</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/blog/categories/%E5%8D%9A%E5%AE%A2/Java/%E6%BA%90%E7%A0%81/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">源码</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/blog/tags/Spring-Boot/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">Spring Boot</span></a></span></div><div class="post-author"><span class="author-name">thetianxia</span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><h2 id="SpringBoot启动类-2-4-5"><a href="#SpringBoot启动类-2-4-5" class="headerlink" title="SpringBoot启动类 2.4.5"></a>SpringBoot启动类 2.4.5</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动类的代码非常简单，我们只需要在SpringBoot项目启动类加上注解@SpringBootApplication，即可标注该类是启动类。在该类的main方法中调用了</p>
<p>SpringApplication.run(Application.class)，所以启动流程就在run中。通过debug，我们看一下源码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1、main方法进来之后，调用了这个run方法，然后这个run又封装了一下参数，调用另一个重载方法run</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(Class&lt;?&gt; primarySource, String... args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> run(<span class="keyword">new</span> Class[]&#123;primarySource&#125;, args);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//2、该run方法，首先新创建一个SpringApplication，该类构造器接受一个启动类参数对象，在构造器中，SpringBoot进行了一系列参数初始化。</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(Class&lt;?&gt;[] primarySources, String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> SpringApplication(primarySources)).run(args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SpringApplication构造器-初始化"><a href="#SpringApplication构造器-初始化" class="headerlink" title="SpringApplication构造器,初始化"></a>SpringApplication构造器,初始化</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//3、run方法创建新的SpringApplication对象，调用该构造器，该构造器又调用另一个构造器</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SpringApplication</span><span class="params">(Class&lt;?&gt;... primarySources)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//默认资源加载器ResourceLoader为null</span></span><br><span class="line">    <span class="keyword">this</span>((ResourceLoader)<span class="keyword">null</span>, primarySources);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//4、初始化</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.sources = <span class="keyword">new</span> LinkedHashSet();		<span class="comment">//配置sources</span></span><br><span class="line">    <span class="keyword">this</span>.bannerMode = Mode.CONSOLE;		<span class="comment">//配置横幅，默认打印到控制台。Mode枚举 OFF关闭,CONSOLE控制台打印,LOG日志打印;</span></span><br><span class="line">    <span class="keyword">this</span>.logStartupInfo = <span class="keyword">true</span>;		<span class="comment">//配置是否开启日志，默认开启</span></span><br><span class="line">    <span class="keyword">this</span>.addCommandLineProperties = <span class="keyword">true</span>;		<span class="comment">//配置是否添加命令行属性，默认开启</span></span><br><span class="line">    <span class="keyword">this</span>.addConversionService = <span class="keyword">true</span>;		<span class="comment">//是否添加转换服务，默认开启</span></span><br><span class="line">    <span class="keyword">this</span>.headless = <span class="keyword">true</span>;		<span class="comment">//headless模式</span></span><br><span class="line">    <span class="keyword">this</span>.registerShutdownHook = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">this</span>.additionalProfiles = Collections.emptySet();</span><br><span class="line">    <span class="keyword">this</span>.isCustomEnvironment = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.lazyInitialization = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.applicationContextFactory = ApplicationContextFactory.DEFAULT;		</span><br><span class="line">    <span class="keyword">this</span>.applicationStartup = ApplicationStartup.DEFAULT;		<span class="comment">//DefaultApplicationStartup</span></span><br><span class="line">    <span class="keyword">this</span>.resourceLoader = resourceLoader;		<span class="comment">//null</span></span><br><span class="line">    Assert.notNull(primarySources, <span class="string">&quot;PrimarySources must not be null&quot;</span>);		<span class="comment">//如果没有启动类，启动失败。primarySources一般只有一个启动类，或者null</span></span><br><span class="line">    <span class="keyword">this</span>.primarySources = <span class="keyword">new</span> LinkedHashSet(Arrays.asList(primarySources));		<span class="comment">//保存主配置类</span></span><br><span class="line">    <span class="keyword">this</span>.webApplicationType = WebApplicationType.deduceFromClasspath();		<span class="comment">//判断web类型，SERVLET</span></span><br><span class="line">    <span class="keyword">this</span>.bootstrapRegistryInitializers = <span class="keyword">this</span>.getBootstrapRegistryInitializersFromSpringFactories();		<span class="comment">//获取所有的BootstrapRegistryInitializer实现类保存在List&lt;BootstrapRegistryInitializer&gt; bootstrapRegistryInitializers，锚点1</span></span><br><span class="line">    <span class="keyword">this</span>.setInitializers(<span class="keyword">this</span>.getSpringFactoriesInstances(ApplicationContextInitializer.class));	<span class="comment">//从资源文件配置ApplicationContextInitializer实例并存在List&lt;ApplicationContextInitializer&lt;?&gt;&gt; initializers;锚点2</span></span><br><span class="line">    <span class="keyword">this</span>.setListeners(<span class="keyword">this</span>.getSpringFactoriesInstances(ApplicationListener.class));		<span class="comment">//从资源文件创建应用监听器，保存在List&lt;ApplicationListener&lt;?&gt;&gt; listeners</span></span><br><span class="line">    <span class="keyword">this</span>.mainApplicationClass = <span class="keyword">this</span>.deduceMainApplicationClass();		<span class="comment">//配置应用的主方法所在类</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="锚点1"><a href="#锚点1" class="headerlink" title="锚点1"></a>锚点1</h4><p>SpringBoot启动时初始化上下文时，最终会调用该方法。再改方法中获取classLoader，因为构造器中resourceLoader是null，所以得到的是默认构造器</p>
<p>然后执行该方法SpringFactoriesLoader.loadFactoryNames(type, classLoader)，锚点1之后的流程如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">Collection&lt;T&gt; <span class="title">getSpringFactoriesInstances</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getSpringFactoriesInstances(type, <span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//最终会调用该方法。</span></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">Collection&lt;T&gt; <span class="title">getSpringFactoriesInstances</span><span class="params">(Class&lt;T&gt; type, Class&lt;?&gt;[] parameterTypes, Object... args)</span> </span>&#123;</span><br><span class="line">    ClassLoader classLoader = <span class="keyword">this</span>.getClassLoader();		<span class="comment">//return this.resourceLoader != null ? this.resourceLoader.getClassLoader() : 		ClassUtils.getDefaultClassLoader();返回系统默认类加载器</span></span><br><span class="line">    Set&lt;String&gt; names = <span class="keyword">new</span> LinkedHashSet(SpringFactoriesLoader.loadFactoryNames(type, classLoader));</span><br><span class="line">    List&lt;T&gt; instances = <span class="keyword">this</span>.createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names);</span><br><span class="line">    AnnotationAwareOrderComparator.sort(instances);</span><br><span class="line">    <span class="keyword">return</span> instances;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后进入SpringFactoriesLoader.loadFactoryNames(type, classLoader)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryType, <span class="meta">@Nullable</span> ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">    ClassLoader classLoaderToUse = classLoader;		<span class="comment">//默认加载器</span></span><br><span class="line">    <span class="keyword">if</span> (classLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">        classLoaderToUse = SpringFactoriesLoader.class.getClassLoader();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String factoryTypeName = factoryType.getName();		<span class="comment">//锚点1处是BootstrapRegistryInitializer.class类的全类名</span></span><br><span class="line">    <span class="keyword">return</span> (List)loadSpringFactories(classLoaderToUse).getOrDefault(factoryTypeName, Collections.emptyList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获得全类名之后，进入loadSpringFactories(classLoaderToUse)方法，并得到一个Map类。该方法会从”META-INF/spring.factories”下的文件中读取配置。SpringBoot中只有如图三个路径下存在”META-INF/spring.factories”。我们以锚点1的BootstrapRegistryInitializer为例。</p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262125014.png" alt="1" loading="lazy"></p>
<p>urls中存在3个地址，分别在spring-boot，spring-boot-autoconfigure，spring-beans中。循环将对应地址的文件读入为properties，内容如下图。</p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262132126.png" alt="2" loading="lazy"></p>
<p>如果缓存没有，则读取配置文件，获得Enumeration类型的urls，Enumeration的key是HashTable并且对应的值也存于HashTable中。因此该类将配置文件中的内容做映射。之后通过迭代，获得每一个key和对应的values。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; loadSpringFactories(ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="comment">//先从缓存获取，如果有就直接返回</span></span><br><span class="line">    Map&lt;String, List&lt;String&gt;&gt; result = (Map)cache.get(classLoader);</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        HashMap result = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//没有则从&quot;META-INF/spring.factories&quot;文件中读取，获取&quot;META-INF/spring.factories&quot;的url</span></span><br><span class="line">            Enumeration urls = classLoader.getResources(<span class="string">&quot;META-INF/spring.factories&quot;</span>);</span><br><span class="line">			<span class="comment">//遍历url</span></span><br><span class="line">            <span class="keyword">while</span>(urls.hasMoreElements()) &#123;</span><br><span class="line">                URL url = (URL)urls.nextElement();		</span><br><span class="line">                UrlResource resource = <span class="keyword">new</span> UrlResource(url);</span><br><span class="line">                Properties properties = PropertiesLoaderUtils.loadProperties(resource);		<span class="comment">//从url中读入数据</span></span><br><span class="line">                Iterator var6 = properties.entrySet().iterator();		<span class="comment">//获得迭代器</span></span><br><span class="line">				<span class="comment">//迭代</span></span><br><span class="line">                <span class="keyword">while</span>(var6.hasNext()) &#123;</span><br><span class="line">                    Entry&lt;?, ?&gt; entry = (Entry)var6.next();		<span class="comment">//String，String</span></span><br><span class="line">                    String factoryTypeName = ((String)entry.getKey()).trim();		<span class="comment">//去掉key字符串开头和结尾的空白</span></span><br><span class="line">                    <span class="comment">//value转为数组</span></span><br><span class="line">                    String[] factoryImplementationNames = StringUtils.commaDelimitedListToStringArray((String)entry.getValue());		<span class="comment">//将value字符转为数组</span></span><br><span class="line">                    String[] var10 = factoryImplementationNames;</span><br><span class="line">                    <span class="keyword">int</span> var11 = factoryImplementationNames.length;</span><br><span class="line">					</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">for</span>(<span class="keyword">int</span> var12 = <span class="number">0</span>; var12 &lt; var11; ++var12) &#123;</span><br><span class="line">                        String factoryImplementationName = var10[var12];		</span><br><span class="line">                        ((List)result.computeIfAbsent(factoryTypeName, (key) -&gt; &#123;		<span class="comment">//第一次会返回空数组，并将第一个元素去掉开头和结尾的空白并添加到数组，之后都获取该数组并向其中添加元素。</span></span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">new</span> ArrayList();</span><br><span class="line">                        &#125;)).add(factoryImplementationName.trim());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">			</span><br><span class="line">            <span class="comment">//最后将map中所有key对应的value去重后更新</span></span><br><span class="line">            result.replaceAll((factoryType, implementations) -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> (List)implementations.stream().distinct().collect(Collectors.collectingAndThen(Collectors.toList(), Collections::unmodifiableList));</span><br><span class="line">            &#125;);</span><br><span class="line">            cache.put(classLoader, result);		<span class="comment">//放入缓存</span></span><br><span class="line">            <span class="keyword">return</span> result;		<span class="comment">//返回map</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var14) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unable to load factories from location [META-INF/spring.factories]&quot;</span>, var14);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回之后，会通过getOrDefault方法返回BootstrapRegistryInitializer.class对应的配置集合。然后执行List instances = this.createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names);</p>
<p>该方法通过反射，用names中的全部类的全类名创建实例对象集合，然后排序之后返回。</p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262132235.png" alt="3.png" loading="lazy"></p>
<p>返回之后，保存到SpringApplication对象的属性中。</p>
<h4 id="锚点2"><a href="#锚点2" class="headerlink" title="锚点2"></a>锚点2</h4><p>初始化BootstrapRegistryInitializer.class之后，会初始化ApplicationContextInitializer和ApplicationListener监听器相关的类。过程同锚点1一样。只不过在loadSpringFactories方法中，会直接返回缓存中的map并返回对应的list。</p>
<h3 id="Run具体启动"><a href="#Run具体启动" class="headerlink" title="Run具体启动"></a>Run具体启动</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">    StopWatch stopWatch = <span class="keyword">new</span> StopWatch();		<span class="comment">//计时</span></span><br><span class="line">    stopWatch.start();</span><br><span class="line">    DefaultBootstrapContext bootstrapContext = <span class="keyword">this</span>.createBootstrapContext();</span><br><span class="line">    ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.configureHeadlessProperty();</span><br><span class="line">    <span class="comment">//创建并启动监听器</span></span><br><span class="line">    SpringApplicationRunListeners listeners = <span class="keyword">this</span>.getRunListeners(args);		<span class="comment">//锚点3，获取监听器</span></span><br><span class="line">    listeners.starting(bootstrapContext, <span class="keyword">this</span>.mainApplicationClass);		<span class="comment">//锚点4，启动监听器</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(args);</span><br><span class="line">        ConfigurableEnvironment environment = <span class="keyword">this</span>.prepareEnvironment(listeners, bootstrapContext, applicationArguments);	<span class="comment">//锚点7，准备环境</span></span><br><span class="line">        <span class="keyword">this</span>.configureIgnoreBeanInfo(environment);</span><br><span class="line">        Banner printedBanner = <span class="keyword">this</span>.printBanner(environment);		<span class="comment">//根据配置打印banner</span></span><br><span class="line">        <span class="comment">//创建ioc</span></span><br><span class="line">        context = <span class="keyword">this</span>.createApplicationContext();</span><br><span class="line">        context.setApplicationStartup(<span class="keyword">this</span>.applicationStartup);</span><br><span class="line">        <span class="keyword">this</span>.prepareContext(bootstrapContext, context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">        <span class="keyword">this</span>.refreshContext(context);</span><br><span class="line">        <span class="keyword">this</span>.afterRefresh(context, applicationArguments);</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">            (<span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass)).logStarted(<span class="keyword">this</span>.getApplicationLog(), stopWatch);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        listeners.started(context);</span><br><span class="line">        <span class="keyword">this</span>.callRunners(context, applicationArguments);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var10) &#123;</span><br><span class="line">        <span class="keyword">this</span>.handleRunFailure(context, var10, listeners);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(var10);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        listeners.running(context);</span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var9) &#123;</span><br><span class="line">        <span class="keyword">this</span>.handleRunFailure(context, var9, (SpringApplicationRunListeners)<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(var9);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="锚点3"><a href="#锚点3" class="headerlink" title="锚点3"></a>锚点3</h4><p>SpringApplicationRunListeners listeners = this.getRunListeners(args);这个方法比较重要，目的是获取一个封装的SpringApplicationRunListeners对象。该类中一个属性List listeners中最后会有一个元素EventPublishingRunListener。</p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262132254.png" alt="4.png" loading="lazy"></p>
<p>下面，通过断点，我们看一下封装过程。</p>
<p>可以看到getRunListeners直接new了一个SpringApplicationRunListeners。之后我们看该构造函数，现在我们先看参数this.getSpringFactoriesInstances(SpringApplicationRunListener.class, types, this, args)最后会是什么。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> SpringApplicationRunListeners <span class="title">getRunListeners</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt;[] types = <span class="keyword">new</span> Class[]&#123;SpringApplication.class, String[].class&#125;;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringApplicationRunListeners(logger, <span class="keyword">this</span>.getSpringFactoriesInstances(SpringApplicationRunListener.class, types, <span class="keyword">this</span>, args), <span class="keyword">this</span>.applicationStartup);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法，我们在之前SpringApplication构造其中，就见过多次。它从一个map中获取对应的List集合。我们进去看一下，果然，一样的配方。最后names只有一个元素，就是EventPublishingRunListener类的全限定类名。之后又调用了List instances = this.createSpringFactoriesInstances(type, parameterTypes, classLoader, args, names);这行代码进行反射获取实例。最后代码会运行到EventPublishingRunListener的构造器处。我们往下看。</p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262133370.png" alt="5.png" loading="lazy"></p>
<p>标注的这一行，将过去的构造函数和参数传入，反射创建对象。</p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262133424.png" alt="6.png" loading="lazy"></p>
<p>ctor就是上一步的传入的构造函数，这里直接传入参数开始构建。参数中包含的就是之前new的并且初始化的SpringApplication对象。<br><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262133278.png" alt="7.png" loading="lazy"></p>
<p>调用EventPublishingRunListener构造器创建对象。该类有三个参数，application是通过参数传递的，用来获取初始化时创建的监听器对象集合，并获取迭代器var3。然后将监听器封装到initialMulticaster属性中。initialMulticaster的类型是 public class SimpleApplicationEventMulticaster extends AbstractApplicationEventMulticaster，它的父类中，有一个内部类，该内部类中有一个集合，最终这些listener会存到该集合中。</p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262133100.png" alt="8.png" loading="lazy"></p>
<p>内部类部分代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addApplicationListener</span><span class="params">(ApplicationListener&lt;?&gt; listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>.defaultRetriever) &#123;</span><br><span class="line">            Object singletonTarget = AopProxyUtils.getSingletonTarget(listener);</span><br><span class="line">            <span class="keyword">if</span> (singletonTarget <span class="keyword">instanceof</span> ApplicationListener) &#123;</span><br><span class="line">                <span class="keyword">this</span>.defaultRetriever.applicationListeners.remove(singletonTarget);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.defaultRetriever.applicationListeners.add(listener);</span><br><span class="line">            <span class="keyword">this</span>.retrieverCache.clear();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//内部类</span></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultListenerRetriever</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> Set&lt;ApplicationListener&lt;?&gt;&gt; applicationListeners;		<span class="comment">//最终存放监听器处</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> Set&lt;String&gt; applicationListenerBeans;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">DefaultListenerRetriever</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.applicationListeners = <span class="keyword">new</span> LinkedHashSet();</span><br><span class="line">            <span class="keyword">this</span>.applicationListenerBeans = <span class="keyword">new</span> LinkedHashSet();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为初始化一共有9个监听器，所以最终这个集合里面会添加9个监听器。如下图，返回的参数就是instances，里面封装了一个EventPublishingRunListener，EventPublishingRunListener里面有个属性initialMulticaster,里面又封装了一个包含9个监听器的集合。封装套娃。。。。最后通过SpringApplicationRunListeners构造函数，赋值给listeners。最后返回生成的SpringApplicationRunListeners对象。</p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262133633.png" alt="9.png" loading="lazy"></p>
<p>到此为止，锚点3结束。如果套的头晕，建议多看几遍就好了。</p>
<h4 id="锚点4"><a href="#锚点4" class="headerlink" title="锚点4"></a>锚点4</h4><p>获得监听器之后，启动监听器。这个方法最后调用了doWithListeners方法。我们可以看到里面将linsteners中的监听器（其实就是EventPublishingRunListener）分别执行lambda中listener.starting(bootstrapContext)，所以我们去EventPublishingRunListener中找对应的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">starting</span><span class="params">(ConfigurableBootstrapContext bootstrapContext, Class&lt;?&gt; mainApplicationClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.doWithListeners(<span class="string">&quot;spring.boot.application.starting&quot;</span>, (listener) -&gt; &#123;</span><br><span class="line">            listener.starting(bootstrapContext);</span><br><span class="line">        &#125;, (step) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (mainApplicationClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">                step.tag(<span class="string">&quot;mainApplicationClass&quot;</span>, mainApplicationClass.getName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doWithListeners</span><span class="params">(String stepName, Consumer&lt;SpringApplicationRunListener&gt; listenerAction, Consumer&lt;StartupStep&gt; stepAction)</span> </span>&#123;</span><br><span class="line">        StartupStep step = <span class="keyword">this</span>.applicationStartup.start(stepName);</span><br><span class="line">        <span class="keyword">this</span>.listeners.forEach(listenerAction);</span><br><span class="line">        <span class="keyword">if</span> (stepAction != <span class="keyword">null</span>) &#123;</span><br><span class="line">            stepAction.accept(step);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        step.end();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用该方法</p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262133028.png" alt="10.png" loading="lazy"></p>
<p>然后来到SimpleApplicationEventMulticaster，最终调用的是下面这个方法。该方法中，重要的是Iterator var5 = this.getApplicationListeners(event, type).iterator();获取符合eventType的监听器的迭代器。我们进入看下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">multicastEvent</span><span class="params">(ApplicationEvent event, <span class="meta">@Nullable</span> ResolvableType eventType)</span> </span>&#123;</span><br><span class="line">        ResolvableType type = eventType != <span class="keyword">null</span> ? eventType : <span class="keyword">this</span>.resolveDefaultEventType(event);</span><br><span class="line">        Executor executor = <span class="keyword">this</span>.getTaskExecutor();		<span class="comment">//null</span></span><br><span class="line">    </span><br><span class="line">    	</span><br><span class="line">        Iterator var5 = <span class="keyword">this</span>.getApplicationListeners(event, type).iterator();	<span class="comment">//锚点5</span></span><br><span class="line">		</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//从锚点6回来，遍历符合条件的监听器，并执行</span></span><br><span class="line">        <span class="keyword">while</span>(var5.hasNext()) &#123;</span><br><span class="line">            ApplicationListener&lt;?&gt; listener = (ApplicationListener)var5.next();</span><br><span class="line">            <span class="keyword">if</span> (executor != <span class="keyword">null</span>) &#123;</span><br><span class="line">                executor.execute(() -&gt; &#123;</span><br><span class="line">                    <span class="keyword">this</span>.invokeListener(listener, event);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//执行</span></span><br><span class="line">                <span class="keyword">this</span>.invokeListener(listener, event);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>this.invokeListener(listener, event)最后会执行到这里，根据监听器执行不同的逻辑。</p>
<h4 id="锚点5"><a href="#锚点5" class="headerlink" title="锚点5"></a>锚点5</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Collection&lt;ApplicationListener&lt;?&gt;&gt; getApplicationListeners(ApplicationEvent event, ResolvableType eventType) &#123;</span><br><span class="line">        Object source = event.getSource();		<span class="comment">//初始化创建的SpringApplication对象</span></span><br><span class="line">        Class&lt;?&gt; sourceType = source != <span class="keyword">null</span> ? source.getClass() : <span class="keyword">null</span>;		<span class="comment">//SpringApplication的全限定类名</span></span><br><span class="line">        AbstractApplicationEventMulticaster.ListenerCacheKey cacheKey = <span class="keyword">new</span> AbstractApplicationEventMulticaster.ListenerCacheKey(eventType, sourceType);		<span class="comment">//将eventType和sourceType封装一个key，后面获取 existingRetriever</span></span><br><span class="line">        AbstractApplicationEventMulticaster.CachedListenerRetriever newRetriever = <span class="keyword">null</span>;</span><br><span class="line">        AbstractApplicationEventMulticaster.CachedListenerRetriever existingRetriever = (AbstractApplicationEventMulticaster.CachedListenerRetriever)<span class="keyword">this</span>.retrieverCache.get(cacheKey);		<span class="comment">//因为开始缓存没有，所以是null，所以进入下边的if</span></span><br><span class="line">        <span class="keyword">if</span> (existingRetriever == <span class="keyword">null</span> &amp;&amp; (<span class="keyword">this</span>.beanClassLoader == <span class="keyword">null</span> || ClassUtils.isCacheSafe(event.getClass(), <span class="keyword">this</span>.beanClassLoader) &amp;&amp; (sourceType == <span class="keyword">null</span> || ClassUtils.isCacheSafe(sourceType, <span class="keyword">this</span>.beanClassLoader)))) &#123;</span><br><span class="line">            <span class="comment">//因为第一次retrieverCache缓存没有，所以new了一个newRetriever，然后放入缓存，cacheKey作为key，newRetriever作为值</span></span><br><span class="line">            newRetriever = <span class="keyword">new</span> AbstractApplicationEventMulticaster.CachedListenerRetriever();</span><br><span class="line">            <span class="comment">//因为不存在，所以newRetriever被放入，返回null，所以existingRetriever是null</span></span><br><span class="line">            existingRetriever = (AbstractApplicationEventMulticaster.CachedListenerRetriever)<span class="keyword">this</span>.retrieverCache.putIfAbsent(cacheKey, newRetriever);</span><br><span class="line">            <span class="keyword">if</span> (existingRetriever != <span class="keyword">null</span>) &#123;</span><br><span class="line">                newRetriever = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//existingRetriever==null,不会执行</span></span><br><span class="line">        <span class="keyword">if</span> (existingRetriever != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Collection&lt;ApplicationListener&lt;?&gt;&gt; result = existingRetriever.getApplicationListeners();		<span class="comment">//符合条件的监听器集合，分析见锚点6</span></span><br><span class="line">            <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//这一步筛选符合条件的监听器并返回。锚点6</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.retrieveApplicationListeners(eventType, sourceType, newRetriever);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="锚点6"><a href="#锚点6" class="headerlink" title="锚点6"></a>锚点6</h4><p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262133895.png" alt="11.png" loading="lazy"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Collection&lt;ApplicationListener&lt;?&gt;&gt; retrieveApplicationListeners(ResolvableType eventType, <span class="meta">@Nullable</span> Class&lt;?&gt; sourceType, <span class="meta">@Nullable</span> AbstractApplicationEventMulticaster.CachedListenerRetriever retriever) &#123;</span><br><span class="line">        List&lt;ApplicationListener&lt;?&gt;&gt; allListeners = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        Set&lt;ApplicationListener&lt;?&gt;&gt; filteredListeners = retriever != <span class="keyword">null</span> ? <span class="keyword">new</span> LinkedHashSet() : <span class="keyword">null</span>;</span><br><span class="line">        Set&lt;String&gt; filteredListenerBeans = retriever != <span class="keyword">null</span> ? <span class="keyword">new</span> LinkedHashSet() : <span class="keyword">null</span>;</span><br><span class="line">        LinkedHashSet listeners;</span><br><span class="line">        LinkedHashSet listenerBeans;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>.defaultRetriever) &#123;</span><br><span class="line">            <span class="comment">//我们 锚点3分析过，this.defaultRetriever.applicationListeners存放的是加载classpath路径下的9个监听器</span></span><br><span class="line">            <span class="comment">//这里加锁，为了防止在执行这一步的同时值被其他线程修改</span></span><br><span class="line">            listeners = <span class="keyword">new</span> LinkedHashSet(<span class="keyword">this</span>.defaultRetriever.applicationListeners);</span><br><span class="line">            listenerBeans = <span class="keyword">new</span> LinkedHashSet(<span class="keyword">this</span>.defaultRetriever.applicationListenerBeans);</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">        Iterator var9 = listeners.iterator();</span><br><span class="line">		</span><br><span class="line">        <span class="keyword">while</span>(var9.hasNext()) &#123;</span><br><span class="line">            ApplicationListener&lt;?&gt; listener = (ApplicationListener)var9.next();</span><br><span class="line">            <span class="comment">//通过方法名字，我们可以推测，如果listener符合eventType和sourceType，那么返回true，最终有4个监听器满足</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.supportsEvent(listener, eventType, sourceType)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (retriever != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//第一次加入filteredListeners</span></span><br><span class="line">                    filteredListeners.add(listener);</span><br><span class="line">                &#125;</span><br><span class="line">				<span class="comment">//符合条件加入filteredListeners</span></span><br><span class="line">                allListeners.add(listener);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//listenerBeans大小为0，不会执行</span></span><br><span class="line">        <span class="keyword">if</span> (!listenerBeans.isEmpty()) &#123;</span><br><span class="line">            ConfigurableBeanFactory beanFactory = <span class="keyword">this</span>.getBeanFactory();</span><br><span class="line">            Iterator var16 = listenerBeans.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var16.hasNext()) &#123;</span><br><span class="line">                String listenerBeanName = (String)var16.next();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.supportsEvent(beanFactory, listenerBeanName, eventType)) &#123;</span><br><span class="line">                        ApplicationListener&lt;?&gt; listener = (ApplicationListener)beanFactory.getBean(listenerBeanName, ApplicationListener.class);</span><br><span class="line">                        <span class="keyword">if</span> (!allListeners.contains(listener) &amp;&amp; <span class="keyword">this</span>.supportsEvent(listener, eventType, sourceType)) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (retriever != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (beanFactory.isSingleton(listenerBeanName)) &#123;</span><br><span class="line">                                    filteredListeners.add(listener);</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    filteredListenerBeans.add(listenerBeanName);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            allListeners.add(listener);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Object listener = beanFactory.getSingleton(listenerBeanName);</span><br><span class="line">                        <span class="keyword">if</span> (retriever != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            filteredListeners.remove(listener);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        allListeners.remove(listener);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NoSuchBeanDefinitionException var13) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">        AnnotationAwareOrderComparator.sort(allListeners);</span><br><span class="line">    	<span class="comment">//将过滤的结果存入缓存，下次通过cacheKey直接获取</span></span><br><span class="line">        <span class="keyword">if</span> (retriever != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (filteredListenerBeans.isEmpty()) &#123;</span><br><span class="line">                retriever.applicationListeners = <span class="keyword">new</span> LinkedHashSet(allListeners);</span><br><span class="line">                retriever.applicationListenerBeans = filteredListenerBeans;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                retriever.applicationListeners = filteredListeners;</span><br><span class="line">                retriever.applicationListenerBeans = filteredListenerBeans;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		</span><br><span class="line">        <span class="keyword">return</span> allListeners;		<span class="comment">//锚点6结束，回到锚点4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="锚点7"><a href="#锚点7" class="headerlink" title="锚点7"></a>锚点7</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ConfigurableEnvironment <span class="title">prepareEnvironment</span><span class="params">(SpringApplicationRunListeners listeners, DefaultBootstrapContext bootstrapContext, ApplicationArguments applicationArguments)</span> </span>&#123;</span><br><span class="line">    ConfigurableEnvironment environment = <span class="keyword">this</span>.getOrCreateEnvironment();		<span class="comment">//获取系统配置信息，以及控制台配置</span></span><br><span class="line">    <span class="keyword">this</span>.configureEnvironment((ConfigurableEnvironment)environment, applicationArguments.getSourceArgs());</span><br><span class="line">    ConfigurationPropertySources.attach((Environment)environment);</span><br><span class="line">    listeners.environmentPrepared(bootstrapContext, (ConfigurableEnvironment)environment);		<span class="comment">//处理环境准备完成相关的监听器，过程参考锚点3到锚点6，不同的是type，因此广播的监听器不同。</span></span><br><span class="line">    DefaultPropertiesPropertySource.moveToEnd((ConfigurableEnvironment)environment);</span><br><span class="line">    <span class="keyword">this</span>.configureAdditionalProfiles((ConfigurableEnvironment)environment);</span><br><span class="line">    <span class="keyword">this</span>.bindToSpringApplication((ConfigurableEnvironment)environment);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.isCustomEnvironment) &#123;</span><br><span class="line">        environment = (<span class="keyword">new</span> EnvironmentConverter(<span class="keyword">this</span>.getClassLoader())).convertEnvironmentIfNecessary((ConfigurableEnvironment)environment, <span class="keyword">this</span>.deduceEnvironmentClass());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ConfigurationPropertySources.attach((Environment)environment);</span><br><span class="line">    <span class="keyword">return</span> (ConfigurableEnvironment)environment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们进入getOrCreateEnvironment方法，因为开始的时候环境是空，所以这里会创建StandardServletEnvironment()，里面进去这里会先调用父类的构造器，StandardEnvironment，AbstractEnvironment。</p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262134828.png" alt="12.png" loading="lazy"></p>
<p>所以最终调用的是AbstractEnvironment的构造器，具体逻辑也是在这里执行的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262134978.png" alt="13.png" loading="lazy"></p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262134741.png" alt="14.png" loading="lazy"></p>
<p>这段逻辑里面，进行了一些初始值的设置，然后再最后一行代码进行了重要的操作。最后一行代码执行的不是该类的方法，而是StandardServletEnvironment类的重写方法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262134720.png" alt="22.png" loading="lazy"></p>
<p>StandardServletEnvironment执行该方法后，又调用父类StandardEnvironment的重写方法。</p>
<p>这里进行了一些初值的设置。</p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262135716.png" alt="15.png" loading="lazy"></p>
<p>重点在父类中。getSystemProperties方法中，会调用System.getProperties()，从这个方法里面就可以获取计算机系统的属性。<br><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262135059.png" alt="16.png" loading="lazy"></p>
<p>接下来会执行这一句。具体作用就如同注释一样。因为到这里环境准备的差不多了，所以就要处理环境准备之后的一些监听器。因此eventType类型是ApplicationEnvironmentPreparedEvent，找到之后进行广播。</p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262135294.png" alt="17.png" loading="lazy"></p>
<h4 id="锚点8"><a href="#锚点8" class="headerlink" title="锚点8"></a>锚点8</h4><p>web项目，会创建一个AnnotationConfigServletWebServerApplicationContext()类。<br><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262135618.png" alt="18.png" loading="lazy"></p>
<p>之后创建启动器，在准备需要创建的beans。</p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262135319.png" alt="19.png" loading="lazy"></p>
<p>prepareContext中会调用下面这个方法。可以看到，这里将this.setInitializers(this.getSpringFactoriesInstances(ApplicationContextInitializer.class))这个地方从配置中读到的初始化相关类进行遍历，并且初始化。初始化前会进行断言，如果不能初始化则抛出异常。</p>
<p>之后会执行相应的监听器。并且会注册单例对象的类名。</p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262135227.png" alt="20.png" loading="lazy"></p>
<p>prepareContext执行完毕之后，会调用refreshContext方法，该方法会将容器的对象刷新激活，之后处理刷新之后的操作。</p>
<p>在激活对象的时候，我们深入会发现，在refresh方法中，会调用onRefresh方法。在这个地方会启动tomcat。启动tomcat之后还会加载一些其他bean。</p>
<p><img src="https://cdn.jsdelivr.net/gh/QjMITU/blog-images/202308262135347.png" alt="21.png" loading="lazy"></p>
<p>到此，springboot启动完毕。</p>
</div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>thetianxia</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://github.com/2023/06/29/SpringBoot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%202.4.5/" title="SpringBoot启动流程---SpringApplication类">https://github.com/2023/06/29/SpringBoot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%202.4.5/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> 许可协议。</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/blog/2023/07/02/ReentrantLock%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="prev" title="ReentrantLock源码分析"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">ReentrantLock源码分析</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/blog/2022/05/17/SpringBoot%E9%85%8D%E7%BD%AE%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90/" rel="next" title="SpringBoot配置多数据源"><span class="post-nav-text">SpringBoot配置多数据源</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>若您有任何想法，都可以与我交流。</span><br></div><style>.utterances {
  max-width: 100%;
}</style><script src="https://utteranc.es/client.js" repo="owner/repo" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2023 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> the tianxia</span></div><div class="powered"><span>由 <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> 驱动 v5.4.0</span><span class="footer-separator">|</span><span>主题 - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.6.2</span></div><div class="live_time"><span>坚持就是胜利</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2021-10-27T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " 天 " + passHour + " 小时 " + passMinute + " 分 " + passSecond + " 秒";
}
blog_live_time();
</script></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></div></body></html>